# Chaining


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

From the [Anthropic Effective Agents
Guide](https://www.anthropic.com/research/building-effective-agents)
![](https://www.anthropic.com/_next/image?url=https%3A%2F%2Fwww-cdn.anthropic.com%2Fimages%2F4zrzovbb%2Fwebsite%2F7418719e3dab222dccb379b8879e1dc08ad34c78-2401x1000.png&w=3840&q=75)
Prompt chaining decomposes a task into a sequence of steps, where each
LLM call processes the output of the previous one. You can add
programmatic checks (see “gate” in the diagram below) on any
intermediate steps to ensure that the process is still on track.

**When to use this workflow:**This workflow is ideal for situations
where the task can be easily and cleanly decomposed into fixed subtasks.
The main goal is to trade off latency for higher accuracy, by making
each LLM call an easier task.

Examples where prompt chaining is useful:

- Generating Marketing copy, then translating it into a different
  language.
- Writing an outline of a document, checking that the outline meets
  certain criteria, then writing the document based on the outline.

``` python
from IPython.display import display, Markdown
```

------------------------------------------------------------------------

<a href="https://github.com/la3d/cosma/blob/main/cosma/chain.py#L21"
target="_blank" style="float:right; font-size:smaller">source</a>

### Chain

>  Chain (name:str, agents:List[cosma.core.Agent]=<factory>,
>             steps:List[dict]=<factory>, input_type:str='text',
>             output_type:str='text', validators:List[Callable]=<factory>)

*A sequence of agents that process information with flexible
input/output types and validation*

------------------------------------------------------------------------

<a href="https://github.com/la3d/cosma/blob/main/cosma/chain.py#L48"
target="_blank" style="float:right; font-size:smaller">source</a>

### Chain.\_\_call\_\_

>  Chain.__call__ (x)

*Execute the chain on input x*

------------------------------------------------------------------------

<a href="https://github.com/la3d/cosma/blob/main/cosma/chain.py#L59"
target="_blank" style="float:right; font-size:smaller">source</a>

### Chain.show

>  Chain.show ()

*Display chain execution with clear, readable formatting*

``` python
# Let's use Cosette to grab a model 
model = models[2]
model
```

    'gpt-4o'

## Basic Chain Composition

The Chain class allows simple composition of AI agents using Python’s
pipe operator (`|`). This provides a clear, readable way to create
processing pipelines.

## Example: Product Description Translation

In this example, we create a chain that: 1. Generates a product
description in English 2. Translates it to Spanish 3. Maintains
formatting and style

``` python
# Create specialized agents
writer = Agent("writer", model, system="Create concise, engaging product descriptions")
translator = Agent("translator", model, system="Translate while maintaining tone and style")

# Compose the chain
chain = Chain("product_translator")
chain.agents = [writer, translator]

# Test with a simple prompt
prompt = "Describe a smart coffee maker"
result = chain(prompt)
```

The chain maintains a history of each step, showing inputs and outputs
for debugging and analysis.

``` python
# Create our test agents
writer = Agent("writer", model, system="Create concise, engaging product descriptions")
translator = Agent("translator", model, system="Translate to spanish while maintaining tone and style")

# Simple chain
chain = Chain("product_translator")
chain.agents = [writer, translator]

# Test it
prompt = "Describe a smart coffee maker"
result = chain(prompt)
display(Markdown(chain.show()))
```

# product_translator

## Structure

1.  writer ↓
2.  translator

## Execution

Step 1: writer

Input:

    Describe a smart coffee maker

Output:

    Brew the perfect cup every time with our Smart Coffee Maker. Featuring Wi-Fi connectivity, this innovative appliance syncs seamlessly with your smartphone, allowing you to customize brews, set schedules, and receive notifications with ease. With its intuitive touchscreen, voice control compatibility, and auto-cleaning functionality, morning routines have never been more convenient. Ideal for coffee aficionados, it offers precision brewing with programmable strength and temperature settings. Enjoy café-quality coffee at home with smart technology designed to simplify your life.

↓

Step 2: translator

Input:

    Brew the perfect cup every time with our Smart Coffee Maker. Featuring Wi-Fi connectivity, this innovative appliance syncs seamlessly with your smartphone, allowing you to customize brews, set schedules, and receive notifications with ease. With its intuitive touchscreen, voice control compatibility, and auto-cleaning functionality, morning routines have never been more convenient. Ideal for coffee aficionados, it offers precision brewing with programmable strength and temperature settings. Enjoy café-quality coffee at home with smart technology designed to simplify your life.

Output:

    Prepara la taza perfecta cada vez con nuestra Cafetera Inteligente. Con conectividad Wi-Fi, este innovador aparato se sincroniza sin problemas con tu smartphone, permitiéndote personalizar las preparaciones, establecer horarios y recibir notificaciones con facilidad. Con su pantalla táctil intuitiva, compatibilidad con control por voz y función de autolimpieza, las rutinas matutinas nunca han sido más convenientes. Ideal para los aficionados al café, ofrece una preparación precisa con ajustes programables de intensidad y temperatura. Disfruta de café de calidad de cafetería en casa con tecnología inteligente diseñada para simplificar tu vida.

## Structured Data with Chains

Following Anthropic’s best practices for handling structured data, we
can create chains that process and validate XML-formatted information.
This approach offers several benefits:

1.  **Clear Data Structure**: Using XML tags provides explicit structure
    to agent outputs
2.  **Validation**: Easy to verify required fields and format
3.  **Consistent Parsing**: Reliable transformation between formats

### Basic Example: Product Analysis Chain

We’ll create a chain that: - Analyzes product descriptions - Outputs
structured XML data - Validates the structure - Transforms data as
needed

``` python
# 1. Create the analyzer agent
analyzer = Agent("product_analyzer", model,
    system="""You are a product analyzer. When analyzing products, always provide detailed, structured analysis using XML tags. Be thorough but concise.""")
```

``` python
# 2. Create a function to format the prompt
def create_analysis_prompt(product_description: str) -> str:
    return f"""Here is the format to use for your analysis:

<documents>
<document index="1">
<source>product analysis</source>
<document_content>
    <features>List key features</features>
    <pricing>Price range and considerations</pricing>
    <market>Target market segments</market>
</document_content>
</document>
</documents>

Analyze this product: {product_description}"""
```

``` python
# Create chain with structured output
analysis_chain = Chain("product_analyzer")
analysis_chain.agents = [analyzer]

# Test with a product
test_prompt = "Analyze this product: A smart home security camera with AI detection, 4K resolution, and cloud storage."
result = analysis_chain(test_prompt)
display(Markdown(analysis_chain.show()))
```

# product_analyzer

## Structure

1.  product_analyzer

## Execution

Step 1: product_analyzer

Input:

    Analyze this product: A smart home security camera with AI detection, 4K resolution, and cloud storage.

Output:

    ```xml
    <ProductAnalysis>
        <ProductName>Smart Home Security Camera</ProductName>
        <Features>
            <Feature>
                <Name>AI Detection</Name>
                <Description>
                    The camera incorporates artificial intelligence to distinguish between different types of motion events.
                    This helps in reducing false alarms by only notifying the user of significant activities, such as identifying
                    human figures versus animals or passing vehicles.
                </Description>
            </Feature>
            <Feature>
                <Name>4K Resolution</Name>
                <Description>
                    Offers ultra-high-definition video quality, providing clear and detailed images that are essential for
                    identifying faces and other critical details, enhancing the effectiveness of security monitoring.
                </Description>
            </Feature>
            <Feature>
                <Name>Cloud Storage</Name>
                <Description>
                    Provides remote storage solutions where recorded footage is automatically uploaded to the cloud.
                    This feature ensures that video evidence is preserved even if the camera is damaged or stolen.
                    Various storage plans might be available, offering different capacities and retention periods.
                </Description>
            </Feature>
        </Features>
        <Benefits>
            <Benefit>
                <Description>Enhanced security with AI enabling smarter alert systems and decreased false positives.</Description>
            </Benefit>
            <Benefit>
                <Description>Better image quality with 4K resolution ensures critical details aren't missed.</Description>
            </Benefit>
            <Benefit>
                <Description>Remote access to footage from anywhere, thanks to cloud storage solutions.</Description>
            </Benefit>
        </Benefits>
        <Considerations>
            <Consideration>
                <Description>Requires a stable internet connection for effective AI processing and cloud storage management.</Description>
            </Consideration>
            <Consideration>
                <Description>May incur additional costs related to cloud storage subscriptions beyond initial purchase.</Description>
            </Consideration>
            <Consideration>
                <Description>High-resolution video files (4K) will consume more bandwidth and storage space than lower resolutions.</Description>
            </Consideration>
        </Considerations>
    </ProductAnalysis>

    :::
    :::


    ---

    [source](https://github.com/la3d/cosma/blob/main/cosma/chain.py#L82){target="_blank" style="float:right; font-size:smaller"}

    ### extract_xml

    >      extract_xml (text:str, tag:str)

    *Extract content from XML tags, including CDATA sections*


    ::: {.cell}
    ``` {.python .cell-code}
    def create_analysis_prompt(product_description: str) -> str:
        return f"""Here is the format to use for your analysis:

    <documents>
    <document index="1">
    <source>product analysis</source>
    <document_content>
        <features>
        - Key feature 1
        - Key feature 2
        </features>
        <pricing>
        - Price range
        - Key pricing factors
        </pricing>
        <market>
        - Target market 1
        - Target market 2
        </market>
    </document_content>
    </document>
    </documents>

    Analyze this product: {product_description}"""

``` python
# First run our analysis
test_product = "A smart home security camera with AI detection, 4K resolution, and cloud storage."
result = analysis_chain(create_analysis_prompt(test_product))

# Now extract from the nested structure
document_content = extract_xml(result, 'document_content')
features = extract_xml(document_content, 'features')
pricing = extract_xml(document_content, 'pricing')
market = extract_xml(document_content, 'market')

# Show the extracted content
print("Features:\n", features)
print("\nPricing:\n", pricing)
print("\nMarket:\n", market)
```

    Features:
     - AI Detection for advanced motion recognition to minimize false alerts
                    - 4K Resolution providing detailed and crystal-clear video footage
                    - Cloud Storage offering secure, remote access to recorded content

    Pricing:
     - Price range: $150 to $400
                    - Key pricing factors: Quality of AI technology, cost of cloud storage subscription, and inclusion of features such as night vision or two-way audio

    Market:
     - Target market 1: Tech-savvy homeowners interested in smart security solutions
                    - Target market 2: Small businesses needing robust surveillance systems
